defmodule Xsens.MocapDataTest do
  use ExUnit.Case

  doctest Xsens.MocapData

  test "raises error on a wrong header" do
    {:error, "Unknown header couc"} = Xsens.MocapData.parse("coucouLesAmis")
  end

  test "raises error on a wrong message type" do
    {:error, "Unknown message type 08"} = Xsens.MocapData.parse("MXTP08")
  end

  test "parses a correct header" do
    example_frame =
      String.trim("""
          MXTP01\x00\x00\x05\xc2\x80\x17\x00\x00\x17\xfd\x00\x17\x00\x00\x00\x00\x02\x84\x00\x00\x00\x01\xc3\xe9\xdagB\xb4\xb3h\xc2\x14\xbd\x00C1\xba\xf3B\x83\x87gC,-\x13\x00\x00\x00\x02\xc3\xe9\xdb8B\xc8\\\xba\xc2\x12Q4\xc3*\xf2\xddB\x80t\x8fC1o\t\x00\x00\x00\x03\xc3\xe9.YB\xd6\x9d\xc5\xc2\x14N|\xc3,\x10\xd4B}\xa7\xbfC3or\x00\x00\x00\x04\xc3\xe8\xca\xd0B\xe3\xd1\xf2\xc2\x15\xbb\xa1\xc3\'\x8f\xb6Bz j\xc32\xc5\x87\x00\x00\x00\x05\xc3\xe8G\xc6B\xf0\xe7\xae\xc2\x18\'\'\xc3\x1eyLBwR\x1b\xc31\x8f\xa3\x00\x00\x00\x06\xc3\xe7\x0b\x92C\x00\xab\'\xc2\x1e0P\xc3\x10\x8b\xdeB\x80\xd4\xb8\xc3-\x0e\x1c\x00\x00\x00\x07\xc3\xe54\x1dC\x08$\'\xc2&\xeb\xe1\xc3\x18\xd4\xa8B\x8a\x13)\xc3"\xe3\xaf\x00\x00\x00\x08\xc3\xe7#\x8fB\xfaTS\xc2\x15\x07-\xc3\x14\xd2\x10B\x89\xcb?\xc3&te\x00\x00\x00\t\xc3\xe5,\xa1B\xfc.Q\xc1\xd6\xb4EB\xb9]\x1aB\'\xd3`B\x9f\x86\xa5\x00\x00\x00\n\xc3\xe6\xe9\x19B\xd5\xb9\xce\xc1\x14[?B\xb0V\xfe\xc2\x0e\r{C1\x0c\xd0\x00\x00\x00\x0b\xc3\xdd\x80\xabB\xd3\xcb\\\xc1\xb5\xbd\x8c\xc0\xbf%<\xc2\x98\x17\xa7\xc2\xc9L\xa3\x00\x00\x00\x0c\xc3\xe8\x04)B\xfa.\x0f\xc2"%z\xc3\x0e\xf3\x86B\x81\xab%\xc3 \xa94\x00\x00\x00\r\xc3\xeaA\x00B\xf7\x00\x1b\xc2J\xaa\xc4\xc3 \xb0\x90B\x00J\x81\xc3\x00\xd8w\x00\x00\x00\x0e\xc3\xf1<pB\xd4R\x16\xc2\x81<o\xc2\xcfG\x8e@\xc4H?\xc0>G\xee\x00\x00\x00\x0f\xc3\xe5\xbe\xa4B\xd1\xf0\xdf\xc2\x86/-\xc2\xd8\x8e\xde\xc0\xa9\xd4\x11\xbf\xdc\x99D\x00\x00\x00\x10\xc3\xe88\xefB\xb4M]\xc1\xe8\'KC!G\xa0Bz\xf5\t\xc33d\x03\x00\x00\x00\x11\xc3\xe0\xfa\xd0B/w\x80\xc2\x10\xea|\xc3-\xe5\xd8B\x83\xf51C0Qo\x00\x00\x00\x12\xc3\xe3\xdc#A\x1fVF\xc2\n\xdeXC0\x1a\xd2B\x99\x1c%C/\x9c\x9b\x00\x00\x00\x13\xc3\xdd\x1b\xdb@\x83\x9a\x8e\xc2\x18+\x85C+\x9b\xf7B\x99\x1c%C/\x9c\x9b\x00\x00\x00\x14\xc3\xeb\xa4\xdaB\xb5\xf0\x1d\xc24:V\xc30T\xbcBK\x04\'C0\xdc\x1c\x00\x00\x00\x15\xc3\xee2\x11B(\xfaR\xc2,L\x84\xc3"\xcb\xc5B<\xd0\xa0C/\x04\x9e\x00\x00\x00\x16\xc3\xf3])A"\n\xad\xc2\x10\xc1AC/\xfakB3\xa7\x18C0\xd3\xdf\x00\x00\x00\x17\xc3\xeeS\xaf@\x97\xdd-\xc2:NmC/\xfakB3\xa7\x18C0\xd3\xdf
      """)

    assert byte_size(example_frame) == 668

    {:ok, {:type01, message_content}} = Xsens.MocapData.parse(example_frame)

    assert byte_size(message_content) == 662

    <<_header::binary-size(18), rest::binary>> = message_content

    assert byte_size(rest) == 644

    {:ok, parsed_segments} = Xsens.MocapData.parse_message_body(rest)
    parsed_first_segment = parsed_segments |> hd
    assert trunc(parsed_first_segment.x) == -467
  end

  test "I understand max and map correctly" do
    example = [%{x: 7}, %{x: 9}]
    assert Enum.map(example, &Map.get(&1, :x)) == [7, 9]
    assert Enum.max(Enum.map(example, &Map.get(&1, :x))) == 9
  end
end
